{% if menu %}
	{% for item in items %}
		{% set has_children = item.children|length > 0 %}
		{% set featured = {
			'image': item.get_meta('featured_image') ?: 'https://placehold.co/600x400',
			'title': item.get_meta('featured_title') ?: item.title,
			'desc': item.get_meta('featured_desc') ?: 'Дізнайтеся більше про наші проекти.',
			'link': item.get_meta('featured_link') ?: item.link,
			'button_text': item.get_meta('featured_button') ?: 'Докладніше'
		} %}

		<div class="{{ has_children ? 'group' : '' }} flex items-center h-full static js-menu-item">
			<a href="{{ item.link }}" class="px-3 py-6 text-[15px] font-medium text-header-link transition-colors flex items-center gap-1 cursor-pointer">
				{{ item.title }}
				{% if has_children %}
					<svg class="w-3 h-3 opacity-50 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewbox="0 0 24 24">
						<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
					</svg>
				{% endif %}
			</a>

			{% if has_children %}
				{# ВИПРАВЛЕНО: Прибрано hidden, додано pointer-events-none #}
				<div class="absolute inset-x-0 top-full z-[100] bg-[#f8f9fa] shadow-2xl border-t border-gray-200 
                            opacity-0 invisible pointer-events-none -translate-y-1
                            transition-all duration-300 ease-out js-mega-menu">
					
					<div class="container mx-auto px-4 py-10 grid grid-cols-[280px_1fr] lg:grid-cols-[280px_1fr_380px] gap-10 items-start relative">

						{# КОЛОНКА 1: Другий рівень #}
						<div class="flex flex-col border-r border-gray-200 pr-6 space-y-1 z-20">
							{% for child in item.children %}
								<div class="js-sub-item group/sub" data-menu-id="menu-{{ item.id }}-{{ loop.index }}">
									<a href="{{ child.link }}" class="js-sub-link flex items-center justify-between py-3 px-4 rounded-lg text-[16px] font-semibold text-gray-800 transition-all hover:bg-white hover:text-blue-600">
										<span class="truncate">{{ child.title }}</span>
										{% if child.children %}
											<svg class="w-4 h-4 opacity-40 transition-transform group-hover/sub:translate-x-1" fill="none" stroke="currentColor" viewbox="0 0 24 24">
												<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
											</svg>
										{% endif %}
									</a>
								</div>
							{% endfor %}
						</div>

						{# КОЛОНКА 2: Третій рівень #}
						<div class="relative min-h-[400px] z-10 js-grand-container">
							{% for child in item.children %}
								{% if child.children %}
									<div id="menu-{{ item.id }}-{{ loop.index }}" class="js-grand-content absolute inset-0 hidden flex-col gap-x-8 content-start animate-in fade-in duration-200">
                                        <div class="grid gap-x-8">
                                            {% for grandchild in child.children %}
                                                <a href="{{ grandchild.link }}" class="py-2.5 border-b border-gray-100 text-[15px] text-gray-600 hover:text-blue-600 transition-colors">
                                                    <span class="truncate">{{ grandchild.title }}</span>
                                                </a>
                                            {% endfor %}
                                        </div>
									</div>
								{% endif %}
							{% endfor %}
						</div>

						{# КОЛОНКА 3: Featured #}
						<div class="hidden lg:flex bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex-col gap-5 items-start w-[380px] ml-auto z-20">
							<div class="overflow-hidden rounded-xl w-full aspect-video">
								<img class="w-full h-full object-cover transition-transform duration-500 hover:scale-105" src="{{ featured.image }}" alt="{{ featured.title }}">
							</div>
							<div class="flex flex-col gap-3 text-left">
								<h5 class="text-lg font-bold text-gray-900 leading-tight">{{ featured.title }}</h5>
								<p class="text-sm text-gray-500 leading-relaxed italic">{{ featured.desc }}</p>
								<a href="{{ featured.link }}" class="mt-2 inline-flex items-center gap-2 font-bold text-blue-600 hover:text-blue-700 transition-all text-sm uppercase tracking-wide">
									<span>{{ featured.button_text }} →</span>
								</a>
							</div>
						</div>
					</div>
				</div>
			{% endif %}
		</div>
	{% endfor %}
{% endif %}
